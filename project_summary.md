# Сводка по проекту "InvoiceReconciler"

## 1. Общая цель проекта

Основная цель проекта "InvoiceReconciler" - автоматизировать процесс сверки банковских транзакций с выставленными счетами-фактурами. Программа должна определять, какие счета были оплачены (полностью или частично), а также предоставлять отчет о текущей задолженности по каждой компании.

## 2. Входные данные

Программа работает с двумя основными файлами:
- `Bank History.xls`: Выписка банковской истории.
- `Invoices.xlsx`: Список выставленных счетов-фактур (инвойсов).

## 3. Выходные данные (Планируемые отчеты)

1.  **Отчет о сверке (`reconciliation_report.xlsx`)**:
    *   Показывает каждую банковскую транзакцию и сопоставленный с ней инвойс (если найден).
    *   Учитывает частичные оплаты.
    *   Включает неоплаченные/частично оплаченные инвойсы в конец отчета.
    *   Формат: Банковские данные (Дата, ВОЕН, Сумма, Описание), затем данные инвойса (№, ВОЕН, Компания, Дата, Сумма, Остаток, Статус).
    *   Столбцы имеют заданную ширину и русские заголовки.

2.  **Отчет о задолженности компаний (`company_debt_report.xlsx`)**:
    *   **Цель**: Отобразить хронологическую историю задолженности по каждой компании.
    *   **Особенности**:
        *   Одна компания может иметь несколько VÖEN-ов.
        *   Формат: Каждый четвертый столбец - отдельная компания.
        *   Под названием компании - список ее VÖEN-ов.
        *   Далее - хронологический список событий (инвойсы и платежи).
        *   Инвойсы: `INV <Сумма>`, ячейка желтого цвета.
        *   Платежи: `<Сумма>`, ячейка зеленого цвета.
        *   В конце блока компании - итоговый баланс задолженности.
        *   Все цвета должны быть светлыми.

## 4. Проделанная работа и решенные проблемы

На данный момент реализована и отлажена большая часть функционала для **Отчета о сверке (`reconciliation_report.xlsx`)**:

*   **Загрузка данных**:
    *   Реализованы функции `load_invoices()` и `load_bank_history()` для чтения данных.
    *   `load_invoices()`: Пропускает первые 11 строк, выбирает нужные столбцы (№, VÖEN, Название компании, Дата инвойса, Итоговая сумма), переименовывает их, очищает VÖEN, преобразует даты и суммы, создает `Remaining_Amount` и `Status`.
    *   `load_bank_history()`: Пропускает первые 17 строк, выбирает нужные столбцы (VÖEN, дата, тип, сумма, описание), оставляет только входящие платежи (`(+) CR`), очищает VÖEN, преобразует даты.
*   **Проблема с форматом `.xls` (решена)**:
    *   Изначально `pandas` не мог прочитать `Bank History.xls`, выдавая ошибку `Expected BOF record; found b'<html>\r\n'`.
    *   **Причина**: Файл `.xls` на самом деле является HTML-таблицей, сохраненной с расширением `.xls`.
    *   **Решение**: Изменено чтение файла на `pd.read_html()`, что позволяет корректно парсить HTML-структуру.
*   **Проблема с масштабом сумм (решена)**:
    *   Суммы в `Bank_Payment_Amount` были завышены в 100 раз.
    *   **Причина**: Вероятно, десятичный разделитель (запятая) игнорировался, или данные подразумевали два знака после запятой без явного разделителя.
    *   **Решение**: После преобразования `Payment_Amount` в числовой формат, добавлено деление на 100 (`df['Payment_Amount'] = df['Payment_Amount'] / 100`).
*   **Проблема с отсутствием `xlrd` и `xlsxwriter` (решена)**:
    *   Библиотеки `xlrd` (для старых XLS) и `xlsxwriter` (для расширенной записи XLSX) не были установлены.
    *   **Решение**: Установлены через `pip install xlrd` и `pip install xlsxwriter`.
*   **Проблема с форматом даты в отчете (решена)**:
    *   Даты отображались с временем (`YYYY-MM-DD HH:MM:SS`).
    *   **Решение**: Добавлено форматирование `.dt.date` для столбцов дат перед сохранением в Excel.
*   **Проблема `AttributeError: Can only use .dt accessor with datetimelike values` (решена)**:
    *   Возникала после объединения DataFrame, когда столбцы дат могли терять тип `datetime` из-за `NaN` значений.
    *   **Решение**: Добавлено явное преобразование столбцов дат обратно в `datetime` (`pd.to_datetime(..., errors='coerce')`) после конкатенации, но до применения `.dt.date`.
*   **Настройка Excel-отчета**:
    *   Установлена пользовательская ширина столбцов в `reconciliation_report.xlsx` с использованием `xlsxwriter`.
    *   Заголовки столбцов в `reconciliation_report.xlsx` переименованы на короткие русские названия (например, "Дата Оп.", "ВОЕН Банк", "Компания").
*   **Git**: Код был закоммичен в репозиторий GitHub.

## 5. Текущие задачи и планы

Основная текущая задача - реализация **Отчета о задолженности компаний (`company_debt_report.xlsx`)**.

### Детали реализации `company_debt_report.xlsx`:

1.  **Функция `generate_company_report(invoices_df, bank_history_df)`**:
    *   Будет принимать исходные (или очищенные) DataFrame с инвойсами и банковской историей.
    *   **Шаг 1: Сопоставление VÖEN-ов с компаниями**:
        *   Необходимо создать словарь или DataFrame, который для каждой `Company_Name` будет содержать список всех связанных `VOEN` из `invoices_df`. Это важно, так как одна компания может использовать несколько VÖEN-ов.
    *   **Шаг 2: Сбор всех финансовых событий по компаниям**:
        *   Для каждой компании (и ее VÖEN-ов) собрать все соответствующие инвойсы (как "ожидаемые поступления") и все банковские платежи (как "фактические поступления").
        *   Каждое событие должно содержать: дату, сумму, тип события (инвойс/платеж), и, возможно, ссылку на номер инвойса или описание платежа.
        *   Все события должны быть отсортированы хронологически.
    *   **Шаг 3: Генерация Excel-файла с форматированием**:
        *   Использование `xlsxwriter` для создания сложного макета.
        *   **Динамическое размещение столбцов**: Каждая компания будет занимать 4 столбца.
        *   **Форматирование заголовков компаний**: Объединение ячеек для названия компании.
        *   **VÖEN-ы**: Список VÖEN-ов под названием компании.
        *   **Хронологическая история**:
            *   Дата события в первом столбце блока компании.
            *   Описание/сумма события во втором столбце блока компании.
            *   **Цвета**:
                *   Инвойсы: Ячейка с суммой `INV <Сумма>` - светло-желтый фон.
                *   Платежи: Ячейка с суммой `<Сумма>` - светло-зеленый фон.
            *   **Баланс**: В конце блока каждой компании - итоговый баланс задолженности.
        *   **Ширина столбцов**: Возможно, потребуется динамическая настройка ширины или использование фиксированной ширины для блоков компаний.

## 6. Следующие шаги для "нового меня"

1.  **Реализовать функцию `generate_company_report`**:
    *   Начать с логики сопоставления VÖEN-ов с компаниями.
    *   Затем собрать и отсортировать все финансовые события.
    *   Приступить к генерации Excel-отчета с учетом всех требований по форматированию (объединение ячеек, цвета, динамическое размещение).
2.  **Тестирование**: Тщательно протестировать новый отчет на корректность данных и форматирования.
3.  **Очистка кода**: После завершения функционала, удалить все временные отладочные `print()`-вызовы.

---

```